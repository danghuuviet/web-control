<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanoid Robot Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>🤖 Humanoid Robot Control Panel</h1>
  </header>

  <p id="transcript">Heard: (none)</p>
  <p id="last-command">Command: None</p>

  <!-- Controls -->
  <div class="controls">
    <button class="btn btn-primary" style="grid-area: forward;" id="btn-forward" onclick="sendCommand('forward')">
      <i class="bi bi-arrow-up"></i>
    </button>
    <button class="btn btn-secondary" style="grid-area: left;" id="btn-left" onclick="sendCommand('left')">
      <i class="bi bi-arrow-left"></i>
    </button>
    <button class="btn btn-warning" style="grid-area: voice;" id="btn-voice" onclick="startVoiceCommand()">
      <i class="bi bi-mic"></i>
    </button>
    <button class="btn btn-secondary" style="grid-area: right;" id="btn-right" onclick="sendCommand('right')">
      <i class="bi bi-arrow-right"></i>
    </button>
    <button class="btn btn-danger" style="grid-area: backward;" id="btn-backward" onclick="sendCommand('backward')">
      <i class="bi bi-arrow-down"></i>
    </button>
  </div>

  <!-- Ultrasonic Gauge -->
  <h2>📏 Distance</h2>
  <div class="d-flex justify-content-center my-3">
    <div class="gauge">
      <div class="gauge-fill"></div>
      <div class="gauge-cover" id="distance-value">0 cm</div>
    </div>
  </div>

  <!-- Command history -->
  <h2>🕹️ Command history</h2>
  <ul class="list-group" id="command-history"></ul>

  <footer>
    <p>© 2025 Humanoid Control Interface</p>
  </footer>

  <audio id="sound-success" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <!-- Begin JavaScript part  -->
  <script>
    const USERNAME = 'danghuuviet';
    const AIO_KEY = ''; //Insert Your AIO_KEY. Will violate policy of Adafruit when leave it public
    const SENSOR_FEED = 'robot-sensor';
    const COMMAND_FEED = 'robot-direction';

    function flashBackground() {
      document.body.classList.add("flash");
      setTimeout(() => document.body.classList.remove("flash"), 300);
    }

    function playSound() {
      document.getElementById("sound-success").play();
    }

    function highlightButton(id) {
      let btn = document.getElementById(`btn-${id}`);
      if (btn) {
        btn.classList.add("active");
        setTimeout(() => btn.classList.remove("active"), 500);
      }
    }

    function sendCommand(direction) {
      fetch(`https://io.adafruit.com/api/v2/${USERNAME}/feeds/${COMMAND_FEED}/data`, {
        method: 'POST',
        headers: { 'X-AIO-Key': AIO_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ value: direction })
      }).then(response => {
        if (response.ok) {
          document.getElementById("last-command").textContent = "Command: " + direction;
          highlightButton(direction);
          playSound();
          flashBackground();
          addCommandHistory(direction);
        } else alert("Failed to send command");
      });
    }

    function startVoiceCommand() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Speech recognition not supported in this browser.");
        return;
      }
      let voiceBtn = document.getElementById("btn-voice");
      voiceBtn.classList.add("listening");
      let recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = function(event) {
        let text = event.results[0][0].transcript.toLowerCase();
        document.getElementById("transcript").textContent = "Heard: " + text;
        let cmd = interpretCommand(text);
        if (cmd) sendCommand(cmd);
        else alert("Unrecognized command: " + text);
      };
      recognition.onend = function() {
        voiceBtn.classList.remove("listening");
      };
      recognition.start();
    }

    function interpretCommand(text) {
      if (text.includes("to the left")) return "left";
      if (text.includes("to the right")) return "right";
      if (text.includes("forward") || text.includes("go forward")) return "forward";
      if (text.includes("backward") || text.includes("go back") || text.includes("move back") || text.includes("step back")) return "backward";
      return null;
    }

    function updateGauge(distance) {
      const maxDistance = 400; // cm
      const fill = Math.min(distance / maxDistance, 1);
      const gaugeFill = document.querySelector(".gauge-fill");
      const gaugeValue = document.getElementById("distance-value");
      gaugeFill.style.transform = `rotate(${fill * 0.5}turn)`; 
      gaugeValue.textContent = `${distance} cm`;
    }

    function loadSensorData() {
      fetch(`https://io.adafruit.com/api/v2/${USERNAME}/feeds/${SENSOR_FEED}/data?limit=1`, {
        headers: { 'X-AIO-Key': AIO_KEY }
      })
      .then(response => response.json())
      .then(data => {
        if (!data.length) return;
        const latest = parseFloat(data[0].value);
        updateGauge(latest);
      });
    }

    function addCommandHistory(cmd) {
      const history = document.getElementById("command-history");
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = `${new Date().toLocaleTimeString()} → ${cmd}`;
      history.prepend(li);
      if (history.childElementCount > 5) history.removeChild(history.lastChild);
    }

    setInterval(loadSensorData, 5000);
    loadSensorData();
  </script>
<!--  End JavaScript part  -->
</body>
</html>
